---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PostEntry from "../../../components/PostEntry.astro";
import Pagination from "../../../components/Pagination.astro";

import type { GetStaticPaths, Page } from "astro";
import { getCategoryPosts } from "../../../../utils/process-posts.ts";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  // 获取所有文章
  const writingPosts = await getCategoryPosts("writing");
  const readingPosts = await getCategoryPosts("reading");

  const allPosts = [...writingPosts, ...readingPosts].filter(
    (post) => post.data.public,
  );

  // 从所有文章中提取唯一标签，标签全部小写
  const allTags = [
    ...new Set(
      allPosts
        .map((post) => (post.data.tags || []).map((t) => t.trim().toLowerCase()))
        .flat(),
    ),
  ];
  return allTags.flatMap((tag) => {
    const filteredPosts = allPosts.filter((post) =>
      post.data.tags?.includes(tag),
    );
    return paginate(filteredPosts, {
      params: { tag },
      pageSize: 10,
    });
  });
};

const { page } = Astro.props as { page: Page<PostEntry> };
const { tag } = Astro.params;
const allPosts = page.data;
---

<BaseLayout
  title={`Page - ${page.currentPage} - Dkphhh的收藏夹`}
  description="Dkphhh 的文章收藏夹"
  keywords={["收藏夹", "文章", "更新", "故事"]}
>
  <div class="flex-col-center h-full gap-8">
    <h1 class="text-2xl font-bold">Tag: {tag}</h1>
    <div class="article-list-container">
      {allPosts.map((post) => <PostEntry post={post} />)}
    </div>
    <Pagination
      currentPage={page.currentPage}
      lastPage={page.lastPage}
      pathName=`tags/${tag}`
    />
  </div>
</BaseLayout>
